generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// ENUMS
// ============================================================================

enum Role {
  EMPLOYEE
  HR
  ADMIN
}

enum ComponentType {
  BASIC
  HRA
  STANDARD_ALLOWANCE
  BONUS
  LTA
  FIXED_ALLOWANCE
}

enum ValueType {
  FIXED
  PERCENTAGE
}

// ============================================================================
// CORE USER MODELS
// ============================================================================

model GlobalSerial {
  id         Int @id @default(1)
  lastSerial Int
}

model User {
  id         String @id @default(uuid())
  employeeId String @unique
  email      String @unique
  password   String
  role       Role   @default(EMPLOYEE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile                  EmployeeProfile?
  reviewedLeaveApplications LeaveApplication[]
}

model EmployeeProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  name             String
  photo            String?
  department       String?
  phone            String?
  dob              DateTime?
  address          String?
  emergencyContact String?
  managerId        String?
  manager          EmployeeProfile?  @relation("ManagerToEmployee", fields: [managerId], references: [id])
  directReports    EmployeeProfile[] @relation("ManagerToEmployee")
  designationId    String
  designation      Designation       @relation(fields: [designationId], references: [id])

  joinedAt DateTime

  salary           EmployeeSalary?
  bankDetails      EmployeeBankDetails?
  resume           Resume?
  attendance       Attendance[]
  leaveApplications LeaveApplication[]
}

// ============================================================================
// DESIGNATION & SALARY STRUCTURE (HELPER / TEMPLATE)
// ============================================================================

model Designation {
  id          String  @id @default(uuid())
  name        String  @unique
  description String?

  salaryStructure SalaryStructure?
  employees       EmployeeProfile[]
}

model SalaryStructure {
  id            String      @id @default(uuid())
  designationId String      @unique
  designation   Designation @relation(fields: [designationId], references: [id])

  components SalaryStructureComponent[]
}

model SalaryStructureComponent {
  id                String          @id @default(uuid())
  salaryStructureId String
  salaryStructure   SalaryStructure @relation(fields: [salaryStructureId], references: [id])

  type       ComponentType
  valueType  ValueType
  value      Float // % or fixed value
  orderIndex Int

  @@unique([salaryStructureId, type])
}

// ============================================================================
// EMPLOYEE SALARY (FINAL CALCULATED DATA)
// ============================================================================

model EmployeeSalary {
  id         String          @id @default(uuid())
  employeeId String          @unique
  employee   EmployeeProfile @relation(fields: [employeeId], references: [id])

  monthlyWage Float
  grossSalary Float
  netSalary   Float

  // === Calculated deductions / contributions ===
  pfEmployee      Float
  pfEmployer      Float
  professionalTax Float

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  components EmployeeSalaryComponent[]
}

model EmployeeSalaryComponent {
  id               String         @id @default(uuid())
  employeeSalaryId String
  employeeSalary   EmployeeSalary @relation(fields: [employeeSalaryId], references: [id], onDelete: Cascade)

  type   ComponentType
  amount Float

  @@unique([employeeSalaryId, type])
}

model EmployeeBankDetails {
  id                String          @id @default(uuid())
  employeeProfileId String          @unique
  employeeProfile   EmployeeProfile @relation(fields: [employeeProfileId], references: [id], onDelete: Cascade)

  accountNumber String
  bankName      String
  ifscCode      String

  panNumber    String?
  uanNumber    String?

  verified Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ResumeSkill {
  id        String @id @default(uuid())
  resumeId  String
  resume    Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  name      String          // e.g. React, Node.js, Communication
  level     String?         // Optional: Beginner / Intermediate / Expert

  createdAt DateTime @default(now())

  @@unique([resumeId, name])
}

model ResumeCertification {
  id            String @id @default(uuid())
  resumeId      String
  resume        Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  title         String       // Certification name
  issuer        String?      // Coursera, Google, AWS
  issuedDate    DateTime?
  certificateUrl String?

  createdAt     DateTime @default(now())
}

model Resume {
  id                String   @id @default(uuid())
  employeeProfileId String   @unique
  employeeProfile   EmployeeProfile @relation(fields: [employeeProfileId], references: [id], onDelete: Cascade)

  about             String?
  jobLove           String?
  interests         String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  skills            ResumeSkill[]
  certifications    ResumeCertification[]
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LEAVE
  HOLIDAY
}

model Attendance {
  id                String   @id @default(uuid())

  employeeProfileId String
  employeeProfile   EmployeeProfile @relation(fields: [employeeProfileId], references: [id], onDelete: Cascade)

  date              DateTime        // YYYY-MM-DD (unique per employee)

  checkIn           DateTime?
  checkOut          DateTime?

  workMinutes       Int?             // total worked minutes (excluding breaks)
  breakMinutes      Int?             // total break time
  extraMinutes      Int?             // overtime minutes

  status            AttendanceStatus // PRESENT, ABSENT, LEAVE, HOLIDAY

  isPayable         Boolean @default(true) // false â†’ unpaid / missing attendance

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([employeeProfileId, date])
  @@index([date])
}

enum LeaveType {
  PAID
  SICK
  UNPAID
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

model LeaveApplication {
  id                String   @id @default(uuid())

  employeeProfileId String
  employeeProfile   EmployeeProfile @relation(fields: [employeeProfileId], references: [id], onDelete: Cascade)

  type              LeaveType
  status            LeaveStatus

  startDate         DateTime
  endDate           DateTime
  totalDays         Int

  reason            String?

  appliedAt         DateTime @default(now())

  reviewedById      String?
  reviewedBy        User? @relation(fields: [reviewedById], references: [id])

  reviewedAt        DateTime?
  reviewComment     String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([employeeProfileId])
  @@index([status])
}